function [RGB LambdaNm] = D7HsensitivityNew(LambdaMinMax,LambdaStep,bPLOT)

% function [RGB LambdaNm] = D7HsensitivityNew(LambdaMinMax,LambdaStep,bPLOT)
%
% D7H camera pixel sensitivities were measured by A. D'Antona on October 31, 2012
% These sensitivity profiles are very similar to the measurements J. Burge performed
% two years earlier. However, whereas my measurements assume a conversion of the raw
% pixel sensitivities to sRGB color space, these pixel sensitivities are appropriate 
% for converting the raw camera RGB images to the colorspace of choice.
%
% For example, to convert the raw camera images to XYZ colorspace:
%   [D7H Lnm] = D7HsensitivityNew([400 700],5,0);
%   XYZ       = XYZsensitivity([400 700],5,0);
%   LMS       = LMSsensitivity([400 700],5,0);
%   Wxyz      = D7H\XYZ;
%   Wlms      = D7H\LMS;
%   XYZfit    = D7H*Wxyz;
%   LMSfit    = D7H*Wlms;
%   figure; 
%   subplot(1,2,1); hold on;
%   plot(Lnm,XYZ(:,1),   'r',  Lnm,XYZ(:,2),   'g',  Lnm,XYZ(:,3),   'b'  ,'linewidth',2);
%   plot(Lnm,XYZfit(:,1),'r--',Lnm,XYZfit(:,2),'g--',Lnm,XYZfit(:,3),'b--')
%   Fig.format('Wavelength (nm)','RGB','XYZ'); axis square;
%   legend({'X','Y','Z','X fit','Y fit', 'Z fit'})
%   subplot(1,2,2); hold on;
%   plot(Lnm,LMS(:,1),   'r',  Lnm,LMS(:,2),   'g',  Lnm,LMS(:,3),   'b'  ,'linewidth',2);
%   plot(Lnm,LMSfit(:,1),'r--',Lnm,LMSfit(:,2),'g--',Lnm,LMSfit(:,3),'b--')
%   Fig.format('Wavelength (nm)','RGB','LMS'); axis square;
%   legend({'L','M','S','L fit','M fit', 'S fit'})
% 
% LambdaMinMax: min and max values for which to return sensitivities
%                   default: [400 700]
% LambdaStep:   spacing between successive sensitivity samples
%                   default: 5
% bPLOT:        plot or not
%%%%%%%%%%%%%%%%%%%%%%
% 


if ~exist('LambdaMinMax','var') || isempty(LambdaMinMax)
   LambdaMinMax = [400 700]; 
end
if ~exist('LambdaStep','var') || isempty(LambdaStep)
   LambdaStep = 5; 
end
if ~exist('bPLOT','var') || isempty(bPLOT)
    bPLOT = 0;
end
% rawData = [lambdaNm X Y Z]
rawData = ...
[400	-935000	-482000	-105000
401	-985000	-508000	-111000
402	-1034000	-535000	-117000
403	-786000	-414000	17000
404	-537000	-293000	151000
405	-289000	-173000	286000
406	-40000	-52000	420000
407	30000	-36000	715000
408	100000	-19000	1010000
409	169000	-2000	1305000
410	239000	14000	1600000
411	309000	31000	1895000
412	379000	48000	2190000
413	406000	22000	2822000
414	433000	-3000	3454000
415	460000	-28000	4087000
416	487000	-54000	4719000
417	514000	-79000	5351000
418	541000	-105000	5984000
419	739000	-10000	6782000
420	938000	84000	7580000
421	1137000	178000	8378000
422	1336000	272000	9176000
423	1308000	290000	9529000
424	1280000	308000	9882000
425	1252000	326000	10236000
426	1225000	344000	10589000
427	1193000	362000	10747000
428	1162000	379000	10905000
429	1131000	396000	11063000
430	1100000	414000	11221000
431	1069000	431000	11379000
432	1038000	448000	11537000
433	978000	469000	11744000
434	919000	489000	11951000
435	860000	509000	12158000
436	801000	530000	12366000
437	831000	578000	12623000
438	861000	625000	12880000
439	891000	673000	13138000
440	922000	721000	13395000
441	952000	768000	13652000
442	982000	816000	13910000
443	912000	817000	13775000
444	842000	818000	13640000
445	771000	819000	13505000
446	701000	820000	13370000
447	702000	868000	13512000
448	702000	916000	13655000
449	703000	965000	13798000
450	704000	1013000	13940000
451	705000	1061000	14083000
452	705000	1110000	14226000
453	695000	1215000	14261000
454	684000	1320000	14296000
455	673000	1425000	14331000
456	663000	1530000	14366000
457	665000	1622000	14214000
458	668000	1713000	14062000
459	670000	1805000	13910000
460	673000	1896000	13758000
461	675000	1988000	13606000
462	677000	2080000	13454000
463	692000	2257000	13475000
464	706000	2434000	13497000
465	720000	2611000	13519000
466	734000	2788000	13540000
467	750000	2963000	13337000
468	766000	3138000	13133000
469	782000	3313000	12929000
470	798000	3487000	12725000
471	816000	3572000	12585000
472	834000	3658000	12444000
473	852000	3743000	12303000
474	870000	3828000	12162000
475	888000	3913000	12022000
476	906000	3998000	11881000
477	905000	4100000	11683000
478	904000	4202000	11484000
479	904000	4304000	11286000
480	903000	4406000	11088000
481	888000	4452000	10828000
482	873000	4498000	10569000
483	858000	4544000	10310000
484	843000	4590000	10050000
485	828000	4636000	9791000
486	813000	4682000	9532000
487	802000	4838000	9290000
488	790000	4994000	9049000
489	778000	5149000	8807000
490	767000	5305000	8565000
491	802000	5607000	8273000
492	837000	5910000	7981000
493	872000	6213000	7689000
494	907000	6515000	7397000
495	887000	6615000	7073000
496	867000	6716000	6749000
497	847000	6816000	6426000
498	827000	6917000	6102000
499	807000	7017000	5779000
500	787000	7117000	5455000
501	805000	7349000	5246000
502	823000	7581000	5038000
503	841000	7812000	4829000
504	858000	8044000	4620000
505	876000	8275000	4412000
506	894000	8507000	4203000
507	927000	8767000	3951000
508	960000	9028000	3698000
509	992000	9288000	3446000
510	1025000	9548000	3194000
511	1096000	9690000	3040000
512	1167000	9832000	2885000
513	1238000	9975000	2731000
514	1310000	10117000	2577000
515	1381000	10259000	2423000
516	1452000	10401000	2269000
517	1507000	10545000	2090000
518	1562000	10690000	1910000
519	1617000	10834000	1730000
520	1673000	10979000	1551000
521	1715000	11103000	1434000
522	1757000	11227000	1317000
523	1799000	11351000	1201000
524	1841000	11475000	1084000
525	1773000	11396000	1001000
526	1706000	11318000	919000
527	1639000	11240000	836000
528	1572000	11161000	753000
529	1514000	11138000	718000
530	1456000	11115000	682000
531	1398000	11093000	647000
532	1340000	11070000	612000
533	1282000	11047000	576000
534	1224000	11024000	541000
535	1134000	10960000	501000
536	1044000	10896000	462000
537	954000	10832000	422000
538	863000	10768000	383000
539	823000	10689000	363000
540	782000	10610000	343000
541	741000	10530000	324000
542	700000	10451000	304000
543	659000	10372000	284000
544	619000	10293000	264000
545	609000	10152000	247000
546	599000	10011000	229000
547	589000	9870000	212000
548	579000	9729000	194000
549	583000	9607000	185000
550	587000	9486000	176000
551	591000	9364000	167000
552	595000	9242000	159000
553	599000	9120000	150000
554	603000	8998000	141000
555	643000	8841000	135000
556	682000	8684000	129000
557	722000	8527000	123000
558	761000	8370000	117000
559	800000	8213000	111000
560	840000	8056000	105000
561	1050000	7831000	100000
562	1260000	7606000	96000
563	1470000	7381000	91000
564	1680000	7156000	87000
565	2224000	6995000	86000
566	2767000	6835000	84000
567	3311000	6674000	83000
568	3854000	6513000	82000
569	4670000	6356000	80000
570	5486000	6200000	79000
571	6302000	6043000	78000
572	7118000	5887000	76000
573	7934000	5730000	75000
574	8750000	5573000	74000
575	9979000	5339000	73000
576	11209000	5104000	72000
577	12438000	4870000	71000
578	13667000	4635000	71000
579	14188000	4435000	65000
580	14709000	4234000	59000
581	15230000	4034000	53000
582	15751000	3834000	47000
583	16271000	3633000	41000
584	16792000	3433000	35000
585	17105000	3265000	38000
586	17418000	3097000	41000
587	17730000	2930000	43000
588	18043000	2762000	46000
589	17961000	2622000	41000
590	17878000	2482000	35000
591	17796000	2342000	30000
592	17714000	2202000	25000
593	17632000	2062000	19000
594	17550000	1922000	14000
595	17376000	1760000	12000
596	17202000	1597000	10000
597	17029000	1435000	8000
598	16855000	1272000	5000
599	16642000	1172000	7000
600	16428000	1071000	8000
601	16215000	970000	9000
602	16002000	869000	10000
603	15798000	816000	8000
604	15594000	763000	7000
605	15390000	710000	5000
606	15186000	657000	4000
607	14981000	604000	2000
608	14777000	551000	1000
609	14575000	523000	3000
610	14372000	494000	6000
611	14169000	466000	8000
612	13967000	438000	11000
613	13764000	409000	13000
614	13562000	381000	16000
615	13215000	352000	14000
616	12868000	324000	12000
617	12521000	295000	11000
618	12173000	267000	9000
619	11957000	255000	9000
620	11741000	244000	9000
621	11525000	232000	9000
622	11309000	221000	9000
623	11093000	210000	9000
624	10877000	198000	9000
625	10622000	186000	8000
626	10367000	174000	7000
627	10112000	163000	6000
628	9857000	151000	5000
629	9664000	142000	3000
630	9471000	133000	1000
631	9278000	124000	-1000
632	9085000	114000	-3000
633	8892000	105000	-5000
634	8699000	96000	-7000
635	8442000	85000	-10000
636	8186000	74000	-13000
637	7930000	62000	-16000
638	7673000	51000	-19000
639	7461000	55000	-15000
640	7248000	60000	-11000
641	7035000	64000	-7000
642	6823000	69000	-3000
643	6610000	73000	1000
644	6397000	78000	5000
645	6240000	72000	2000
646	6083000	65000	0
647	5925000	59000	-2000
648	5768000	53000	-4000
649	5620000	52000	-4000
650	5472000	50000	-4000
651	5324000	49000	-4000
652	5176000	47000	-4000
653	5028000	46000	-4000
654	4880000	44000	-4000
655	4723000	38000	-6000
656	4566000	32000	-9000
657	4408000	26000	-12000
658	4251000	20000	-14000
659	4094000	14000	-17000
660	3937000	8000	-19000
661	3669000	9000	-18000
662	3401000	10000	-17000
663	3133000	11000	-15000
664	2865000	12000	-14000
665	2693000	12000	-14000
666	2521000	12000	-14000
667	2349000	11000	-13000
668	2177000	11000	-13000
669	2004000	11000	-13000
670	1832000	11000	-13000
671	1623000	6000	-14000
672	1413000	1000	-15000
673	1203000	-4000	-17000
674	994000	-8000	-18000
675	915000	-10000	-18000
676	837000	-12000	-19000
677	759000	-14000	-19000
678	680000	-16000	-19000
679	602000	-17000	-20000
680	523000	-19000	-20000
681	452000	-23000	-21000
682	380000	-27000	-22000
683	308000	-30000	-23000
684	236000	-34000	-25000
685	219000	-30000	-23000
686	201000	-27000	-20000
687	184000	-24000	-18000
688	167000	-20000	-16000
689	150000	-17000	-14000
690	133000	-13000	-12000
691	124000	-10000	-10000
692	116000	-7000	-8000
693	107000	-3000	-6000
694	99000	0	-4000
695	90000	-1000	-4000
696	82000	-2000	-5000
697	73000	-4000	-6000
698	64000	-5000	-7000
699	56000	-6000	-7000
700	47000	-8000	-8000];



LambdaNm    = [LambdaMinMax(1):LambdaStep:LambdaMinMax(2)]';
RGB = interp1(rawData(:,1),rawData(:,2:4),LambdaNm,'spline');

RGB = bsxfun(@rdivide,RGB,max(RGB));


% WARN IF EXTRAPOLATING BEYOND LIMITS OF DATA
if min(LambdaMinMax) < min(rawData(:,1)) || max(LambdaMinMax) > max(rawData(:,1))
   disp(['D7Hsensitivity: WARNING! extrapolating beyond measured data. minmax(rawdata) = [' num2str(min(rawData(:,1))) ' ' num2str(max(rawData(:,1))) '] vs LambdaMinMax [' num2str(LambdaMinMax(1)) ' ' num2str(LambdaMinMax(2)) ']']); 
end


if bPLOT
    figure; 
    plot(LambdaNm,RGB(:,1),'ro-',LambdaNm,RGB(:,2),'go-',LambdaNm,RGB(:,3),'bo-','linewidth',2);
    Fig.format('Wavelength (nm)','RGB',['D7H new: ' num2str(LambdaStep) 'nm steps']);
    axis square
    ylim([0 1.1])
end